<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Client</title>
    <!-- Include MQTT.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.3.5/mqtt.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        #messages {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            background-color: white;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .status {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h2>MQTT Client</h2>
    <div id="connection-status" class="status">Connecting...</div>
    <div id="messages"></div>

    <script>
        // MQTT Configuration
        const MQTT_BROKER = 'remotemqjp.respiree.com';
        const MQTT_PORT = 8883;
        const MQTT_TOPIC = 'esp32-admin/server/report';
        const MQTT_USERNAME = 'respiree';
        const MQTT_PASSWORD = 'respiree@2020';

        // Messages container
        const messagesDiv = document.getElementById('messages');
        const statusDiv = document.getElementById('connection-status');

        // Add message to the messages div
        function addMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.textContent = message;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Update connection status
        function updateStatus(status) {
            statusDiv.textContent = status;
        }

        // Connect to MQTT broker
        const client = mqtt.connect(`wss://${MQTT_BROKER}:${MQTT_PORT}/mqtt`, {
            username: MQTT_USERNAME,
            password: MQTT_PASSWORD,
            protocolVersion: 4,
            clean: true,
            rejectUnauthorized: false,
            connectTimeout: 30000
        });

        // Connection event handlers
        client.on('connect', () => {
            updateStatus('Connected to MQTT broker');
            
            // Subscribe to topic
            client.subscribe(MQTT_TOPIC, (err) => {
                if (!err) {
                    addMessage(`Subscribed to ${MQTT_TOPIC}`);
                } else {
                    addMessage(`Error subscribing to ${MQTT_TOPIC}: ${err.message}`);
                }
            });
        });

        client.on('message', (topic, message) => {
            const messageText = message.toString();
            addMessage(`Received on ${topic}: ${messageText}`);
        });

        client.on('error', (error) => {
            updateStatus(`Error: ${error.message}`);
        });

        client.on('close', () => {
            updateStatus('Disconnected from MQTT broker');
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (client && client.connected) {
                client.end();
            }
        });
    </script>
</body>
</html>
